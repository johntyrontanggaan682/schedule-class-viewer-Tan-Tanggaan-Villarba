<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Students â€¢ SLSU Lucena</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#0A4B2D', secondary: '#0A4B2D' },
          borderRadius: {
            'none': '0px', 'sm': '4px', DEFAULT: '8px', 'md': '12px', 'lg': '16px',
            'xl': '20px', '2xl': '24px', '3xl': '32px', 'full': '9999px', 'button': '8px'
          },
          boxShadow: {
            card: '0 10px 20px rgba(0,0,0,.06)',
            cardHover: '0 14px 28px rgba(0,0,0,.10)'
          }
        }
      }
    }
  </script>
  <link rel="icon" href="lucenalogo.jpg" type="image/png" sizes="48Ã—48">
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet"/>
  <style>
    :where([class^="ri-"])::before { content: "\f3c2"; }
    .rounded-button { border-radius: 8px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn .25s ease-out both; }

    html, body { overflow-x: hidden; }

    .wm-icon{
      position:absolute; right:-6px; top:-6px;
      font-size:68px; line-height:1; opacity:.06;
      transform: rotate(-10deg);
      pointer-events:none;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-primary text-white shadow-lg fixed w-full top-0 z-50">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <img src="lucenalogo.jpg" alt="SLSU Lucena Logo" class="w-16 h-16 object-contain rounded-full" />
          <h1 class="text-xl font-bold">SLSU Lucena Class Schedule Viewer</h1>
        </div>
        <div class="hidden md:flex items-center space-x-8">
          <a href="index.html#home" class="flex items-center space-x-2 px-3 py-2 rounded-button hover:bg-white/10"><i class="ri-home-line"></i><span>Home</span></a>
          <a href="sections.html" class="flex items-center space-x-2 px-3 py-2 rounded-button hover:bg-white/10"><i class="ri-book-2-line"></i><span>Sections</span></a>
          <a href="schedules.html" class="flex items-center space-x-2 px-3 py-2 rounded-button hover:bg-white/10"><i class="ri-calendar-line"></i><span>Schedules</span></a>
          <a href="students.html" class="flex items-center space-x-2 px-3 py-2 rounded-button bg-white/20"><i class="ri-user-line"></i><span>Students</span></a>
          <a href="teachers.html" class="flex items-centered space-x-2 px-3 py-2 rounded-button hover:bg-white/10"><i class="ri-user-star-line"></i><span>Teachers</span></a>
          <div id="profile-wrap" class="relative">
            <a id="profile-trigger" href="profile.html" class="nav-link relative overflow-hidden flex items-center space-x-2 px-3 py-2 rounded-button hover:bg-white/10 transition">
              <i class="ri-user-3-line"></i><span id="profile-label">Profile</span><i class="ri-arrow-down-s-line text-xs"></i>
            </a>
            <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white text-gray-800 rounded-2xl shadow-2xl border border-gray-200 p-4 z-50">
              <a href="profile.html" class="flex items-center gap-3 hover:opacity-90">
                <div id="acc-avatar" class="w-11 h-11 rounded-full bg-primary/10 text-primary flex items-center justify-center font-semibold overflow-hidden"></div>
                <div class="min-w-0">
                  <div id="acc-name" class="font-semibold truncate"></div>
                  <div id="acc-role" class="text-xs text-gray-500 truncate"></div>
                </div>
              </a>
              <div class="mt-3 space-y-1 text-sm">
                <div class="flex items-center gap-2"><i class="ri-mail-line"></i><span id="acc-email" class="truncate"></span></div>
                <div class="flex items-center gap-2"><i class="ri-id-card-line"></i><span id="acc-id" class="truncate"></span></div>
              </div>
              <div class="mt-4 grid grid-cols-2 gap-2">
                <a id="acc-cta" href="profile.html" class="px-3 py-2 rounded-button bg-primary text-white text-sm text-center active:scale-95 transition">View profile</a>
                <button id="signout-btn" class="px-3 py-2 rounded-button bg-gray-100 text-gray-700 text-sm text-center active:scale-95 transition">Sign out</button>
              </div>
            </div>
          </div>
        </div>
        <button id="mobile-menu-btn" class="md:hidden p-2 rounded-button hover:bg-white/10">
          <i class="ri-menu-line text-xl"></i>
        </button>
      </div>
      <div id="mobile-menu" class="md:hidden mt-4 hidden">
        <div class="space-y-2">
          <a href="index.html#home" class="flex items-center space-x-3 px-3 py-3 rounded-button hover:bg-white/10"><i class="ri-home-line"></i><span>Home</span></a>
          <a href="sections.html" class="flex items-center space-x-3 px-3 py-3 rounded-button hover:bg-white/10"><i class="ri-book-2-line"></i><span>Sections</span></a>
          <a href="schedules.html" class="flex items-center space-x-3 px-3 py-3 rounded-button hover:bg-white/10"><i class="ri-calendar-line"></i><span>Schedules</span></a>
          <a href="students.html" class="flex items-center space-x-3 px-3 py-3 rounded-button bg-white/20"><i class="ri-user-line"></i><span>Students</span></a>
          <a href="teachers.html" class="flex items-centered space-x-3 px-3 py-3 rounded-button hover:bg-white/10"><i class="ri-user-star-line"></i><span>Teachers</span></a>
          <a href="profile.html" class="flex items-center space-x-3 px-3 py-3 rounded-button hover:bg-white/10"><i class="ri-user-3-line"></i><span>Profile</span></a>
        </div>
      </div>
    </div>
  </nav>

  <main class="pt-20">
    <section class="min-h-screen bg-gray-50">
      <div class="px-6 py-16">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-8">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Student Directory</h2>
            <p class="text-sm md:text-base text-gray-600">Select a course and section or search for students</p>
          </div>

          <div id="studentNotice" class="hidden mb-4 border border-amber-200 bg-amber-50 text-amber-800 rounded-xl p-4">
            <div class="flex items-center gap-2">
              <span class="inline-flex h-5 w-5 items-center justify-center flex-shrink-0">
                <i class="ri-information-line text-[18px] leading-none"></i>
              </span>
              <p class="text-sm leading-5">
                Course selection, section selection, and directory search are available only to teachers and administrators..
              </p>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 md:p-4 mb-4">
            <div class="flex flex-col md:flex-row gap-3 md:gap-4">

              <!-- ðŸ”½ NEW: Course combobox -->
              <div class="relative w-full md:w-64">
                <select id="courseSelect"
                        class="absolute inset-0 opacity-0 pointer-events-none"
                        aria-hidden="true" tabindex="-1">
                  <option value="">Select Course</option>
                  <option value="BIT Computer Technology">BIT Computer Technology</option>
                  <option value="BTVT-ED Automotive Technology">BTVT-ED Automotive Technology</option>
                  <option value="BTVT-ED Computer Programming">BTVT-ED Computer Programming</option>
                  <option value="BTVT-ED Civil Technology">BTVT-ED Civil Technology</option>
                  <option value="BTVT-ED Electrical Technology">BTVT-ED Electrical Technology</option>
                  <option value="BTVT-ED Electronics Technology">BTVT-ED Electronics Technology</option>
                  <option value="BTVT-ED Food &amp; Service Management">BTVT-ED Food &amp; Service Management</option>
                  <option value="BTVT-ED Mechanical Technology">BTVT-ED Mechanical Technology</option>
                </select>

                <div id="course-combo" class="relative">
                  <input id="course-input" type="text" autocomplete="off"
                         placeholder="Select Course"
                         class="w-full px-4 py-2.5 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm pr-9"
                         role="combobox" aria-expanded="false" aria-controls="course-list" aria-autocomplete="list" />
                  <button id="course-toggle" type="button"
                          class="absolute right-1.5 top-1/2 -translate-y-1/2 p-1.5 rounded-md hover:bg-gray-100 focus:outline-none"
                          aria-label="Toggle courses">
                    <i class="ri-arrow-down-s-line text-gray-500"></i>
                  </button>
                  <ul id="course-list"
                      class="hidden absolute z-20 mt-1 w-full max-h-60 overflow-auto bg-white border border-gray-200 rounded-lg shadow-lg text-sm"
                      role="listbox"></ul>
                  <div id="course-overlay" class="hidden absolute inset-0 rounded-button bg-white/60 cursor-not-allowed"></div>
                </div>
              </div>
              <!-- ðŸ”¼ END: Course combobox -->

              <div class="relative w-full md:w-64">
                <select id="sectionSelect"
                        class="absolute inset-0 opacity-0 pointer-events-none"
                        aria-hidden="true" tabindex="-1">
                  <option value="">Select Section</option>
                  <!-- initial BIT options; replaced by JS when course is selected -->
                  <option value="BIT 1A-A">BIT 1A-A</option>
                  <option value="BIT 1A-B">BIT 1A-B</option>
                  <option value="BIT 1B-A">BIT 1B-A</option>
                  <option value="BIT 1B-B">BIT 1B-B</option>
                  <option value="BIT 2A-A">BIT 2A-A</option>
                  <option value="BIT 2A-B">BIT 2A-B</option>
                  <option value="BIT 2B-A">BIT 2B-A</option>
                  <option value="BIT 2B-B">BIT 2B-B</option>
                  <option value="BIT 3A-A">BIT 3A-A</option>
                  <option value="BIT 3A-B">BIT 3A-B</option>
                  <option value="BIT 3B-A">BIT 3B-A</option>
                  <option value="BIT 3B-B">BIT 3B-B</option>
                  <option value="BIT 4A-A">BIT 4A-A</option>
                  <option value="BIT 4A-B">BIT 4A-B</option>
                  <option value="BIT 4B-A">BIT 4B-A</option>
                  <option value="BIT 4B-B">BIT 4B-B</option>
                </select>

                <div id="combo" class="relative">
                  <input id="combo-input" type="text" autocomplete="off"
                         placeholder="Select Section"
                         class="w-full px-4 py-2.5 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm pr-9"
                         role="combobox" aria-expanded="false" aria-controls="combo-list" aria-autocomplete="list" />
                  <button id="combo-toggle" type="button"
                          class="absolute right-1.5 top-1/2 -translate-y-1/2 p-1.5 rounded-md hover:bg-gray-100 focus:outline-none"
                          aria-label="Toggle sections">
                    <i class="ri-arrow-down-s-line text-gray-500"></i>
                  </button>
                  <ul id="combo-list"
                      class="hidden absolute z-20 mt-1 w-full max-h-60 overflow-auto bg-white border border-gray-200 rounded-lg shadow-lg text-sm"
                      role="listbox"></ul>
                  <div id="combo-overlay" class="hidden absolute inset-0 rounded-button bg-white/60 cursor-not-allowed"></div>
                </div>
              </div>

              <div class="relative flex-1">
                <input id="searchInput"
                       type="text"
                       placeholder="Search by name, ID, or section..."
                       class="w-full px-4 py-2.5 pl-10 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm"/>
                <i class="ri-search-line absolute left-3 top-1/2 -translate-y-1/2 text-primary"></i>
                <div id="search-overlay" class="hidden absolute inset-0 rounded-button bg-white/60 cursor-not-allowed"></div>
              </div>
            </div>
          </div>

          <!-- Stats (hidden for teachers via JS) -->
          <div id="statsWrap" class="hidden mb-6">
            <div class="grid md:grid-cols-3 lg:grid-cols-4 gap-6">

              <!-- Total Students in Section -->
              <div class="stat-card group relative bg-white border border-gray-200 rounded-xl p-6 shadow-card transition hover:shadow-cardHover hover:-translate-y-0.5 hover:border-primary/40">
                <i class="ri-team-line wm-icon"></i>
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 rounded-full bg-blue-50 ring-1 ring-blue-200/60 flex items-center justify-center">
                    <i class="ri-user-line text-lg text-blue-600"></i>
                  </div>
                  <div>
                    <div class="text-2xl font-bold" id="statTotal">0</div>
                    <div class="text-xs text-gray-500">Total Students in Section</div>
                  </div>
                </div>
              </div>

              <!-- Regular Students -->
              <div class="stat-card group relative bg-white border border-gray-200 rounded-xl p-6 shadow-card transition hover:shadow-cardHover hover:-translate-y-0.5 hover:border-primary/40">
                <i class="ri-user-smile-line wm-icon"></i>
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 rounded-full bg-green-50 ring-1 ring-green-200/60 flex items-center justify-center">
                    <i class="ri-user-smile-line text-lg text-green-600"></i>
                  </div>
                  <div>
                    <div class="text-2xl font-bold" id="statRegular">0</div>
                    <div class="text-xs text-gray-500">Regular Students</div>
                  </div>
                </div>
              </div>

              <!-- Irregular Students -->
              <div class="stat-card group relative bg-white border border-gray-200 rounded-xl p-6 shadow-card transition hover:shadow-cardHover hover:-translate-y-0.5 hover:border-primary/40">
                <i class="ri-alert-line wm-icon"></i>
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 rounded-full bg-orange-50 ring-1 ring-orange-200/60 flex items=center justify-center">
                    <i class="ri-alert-line text-lg text-orange-600"></i>
                  </div>
                  <div>
                    <div class="text-2xl font-bold" id="statIrregular">0</div>
                    <div class="text-xs text-gray-500">Irregular Students</div>
                  </div>
                </div>
              </div>

              <!-- Active Students -->
              <div class="stat-card group relative bg-white border border-gray-200 rounded-xl p-6 shadow-card transition hover:shadow-cardHover hover:-translate-y-0.5 hover:border-primary/40 lg:block hidden">
                <i class="ri-checkbox-circle-line wm-icon"></i>
                <div class="flex items-center space-x-3">
                  <div class="w-10 h-10 rounded-full bg-emerald-50 ring-1 ring-emerald-200/60 flex items-center justify-center">
                    <i class="ri-check-line text-lg text-emerald-600"></i>
                  </div>
                  <div>
                    <div class="text-2xl font-bold" id="statActive">0</div>
                    <div class="text-xs text-gray-500">Active Students</div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div id="emptyState" class="text-center py-6">
            <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 flex items-center justify-center">
              <i class="ri-search-line text-2xl text-gray-400"></i>
            </div>
            <h3 class="mt-3 text-gray-800 font-semibold">Search or Select a Section</h3>
            <p class="mt-1 text-sm text-gray-500">Use the search box to find students by name, ID, or section or pick a section to browse.</p>
          </div>

          <div id="noStudents" class="hidden text-center py-16">
            <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 flex items-center justify-center">
              <i class="ri-user-unfollow-line text-2xl text-gray-400"></i>
            </div>
            <h3 class="mt-6 text-gray-800 font-semibold">No students yet</h3>
            <p class="mt-2 text-sm text-gray-500">This section doesnâ€™t have students yet.</p>
          </div>

          <div id="grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

          <!-- Pagination -->
          <div id="pagi" class="hidden mt-6 flex items-center justify-center gap-2 select-none"></div>

          <div id="noResults" class="hidden text-center py-16">
            <div class="w-16 h-16 mx-auto rounded-full bg-gray-100 flex items-center justify-center">
              <i class="ri-information-line text-2xl text-gray-400"></i>
            </div>
            <h3 class="mt-6 text-gray-800 font-semibold">No matches</h3>
            <p class="mt-2 text-sm text-gray-500">Try a different name, ID, or section.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-primary text-white py-6 mt-12 text-sm">
    <div class="px-6">
      <div class="max-w-6xl mx-auto">
        <div class="grid md:grid-cols-3 gap-6">
          <div>
            <h3 class="font-bold mb-2">SLSU Lucena Campus</h3>
            <p class="text-white/80">Southern Luzon State University Lucena Campus</p>
          </div>
          <div>
            <h3 class="font-bold mb-2">Contact Information</h3>
            <div class="space-y-1 text-white/80">
              <div class="flex items-center gap-2"><i class="ri-map-pin-line"></i><span>Ibabang dupay, Lucena City</span></div>
              <div class="flex items-center gap-2"><i class="ri-phone-line"></i><span>+63 9876543212</span></div>
              <div class="flex items-center gap-2"><i class="ri-mail-line"></i><span>info@slsu-lucena.edu.ph</span></div>
            </div>
          </div>
          <div>
            <h3 class="font-bold mb-2">Quick Links</h3>
            <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-white/80">
              <a href="index.html"     class="hover:text-white">Home</a>
              <a href="sections.html"  class="hover:text-white">Sections</a>
              <a href="schedules.html" class="hover:text-white">Schedules</a>
              <a href="students.html"  class="hover:text-white">Students</a>
              <a href="teachers.html"  class="hover:text-white">Teachers</a>
              <a href="profile.html"   class="hover:text-white">Profile</a>
            </div>
          </div>
        </div>
        <div class="border-t border-white/20 mt-4 pt-4 text-center text-white/80">
          <p>&copy; 2025 SLSU Lucena Class Schedule Viewer. All rights reserved.</p>
        </div>
      </div>
    </div>
  </footer>

  <div id="signout-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-[60]">
    <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-xl">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full bg-primary/10 text-primary flex items-center justify-center">
          <i class="ri-question-line"></i>
        </div>
        <div class="font-semibold text-gray-900">Sign out?</div>
      </div>
      <p class="mt-3 text-sm text-gray-600">Are you sure you want to sign out?</p>
      <div class="mt-6 flex items-center justify-end gap-2">
        <button id="cancel-signout" class="px-4 py-2 rounded-button bg-gray-100">Cancel</button>
        <button id="confirm-signout" class="px-4 py-2 rounded-button bg-primary text-white">Yes</button>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
      document.getElementById('mobile-menu')?.classList.toggle('hidden');
    });
  </script>

  <!-- Data / logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    if (!window.__FB) {
      const firebaseConfig = {
        apiKey: "AIzaSyAZLXYqe3TaVzkHZh3i4h78VBwI0KckMpE",
        authDomain: "log-in-cad70.firebaseapp.com",
        projectId: "log-in-cad70",
        storageBucket: "log-in-cad70.firebasestorage.app",
        messagingSenderId: "538387168387",
        appId: "1:538387168387:web:ef65e3ce36c5a405572fb6",
        measurementId: "G-Q6KF6ST8XF"
      };
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);
      window.__FB = { app, db };
    }
    const { db } = window.__FB;

    const courseSelect  = document.getElementById('courseSelect');
    const sectionSelect = document.getElementById('sectionSelect');
    const searchInput   = document.getElementById('searchInput');
    const grid          = document.getElementById('grid');
    const emptyState    = document.getElementById('emptyState');
    const noResults     = document.getElementById('noResults');
    const noStudents    = document.getElementById('noStudents');
    const statsWrap     = document.getElementById('statsWrap');
    const statTotal     = document.getElementById('statTotal');
    const statRegular   = document.getElementById('statRegular');
    const statIrregular = document.getElementById('statIrregular');
    const statActive    = document.getElementById('statActive');
    const pagi          = document.getElementById('pagi');

    const comboInput   = document.getElementById('combo-input');
    const comboToggle  = document.getElementById('combo-toggle');
    const comboOverlay = document.getElementById('combo-overlay');

    const ROLE = (sessionStorage.getItem('auth_role') || 'guest').toLowerCase();
    const HIDE_STATS = ROLE === 'teacher';
    if (HIDE_STATS && statsWrap) statsWrap.classList.add('hidden');

    const COURSE_SECTION_MAP = {};

    function courseFromSectionDoc(data) {
      if (data && data.course) return data.course;
      const deg = (data && data.degree) ? String(data.degree).toLowerCase() : '';
      if (deg.includes('computer technology')) return 'BIT Computer Technology';
      if (deg.includes('automotive')) return 'BTVT-ED Automotive Technology';
      if (deg.includes('computer programming')) return 'BTVT-ED Computer Programming';
      if (deg.includes('civil')) return 'BTVT-ED Civil Technology';
      if (deg.includes('electrical')) return 'BTVT-ED Electrical Technology';
      if (deg.includes('electronics')) return 'BTVT-ED Electronics Technology';
      if (deg.includes('food') || deg.includes('service')) return 'BTVT-ED Food & Service Management';
      if (deg.includes('mechanical')) return 'BTVT-ED Mechanical Technology';
      return 'BIT Computer Technology';
    }

    function resetCourseSectionMap() {
      Object.keys(COURSE_SECTION_MAP).forEach(k => delete COURSE_SECTION_MAP[k]);
    }

    function addSectionToCourse(course, secId) {
      if (!COURSE_SECTION_MAP[course]) COURSE_SECTION_MAP[course] = new Set();
      COURSE_SECTION_MAP[course].add(secId);
    }

    // enable / disable section combobox based on course
    function setSectionComboEnabledByCourse(enabled) {
      if (ROLE === 'student') return;
      if (!comboInput || !comboOverlay || !comboToggle) return;

      if (!enabled) {
        comboInput.value = '';
        comboInput.placeholder = 'Select a course first';
        comboInput.readOnly = true;
        comboInput.classList.add('cursor-not-allowed','bg-gray-50');
        comboOverlay.classList.remove('hidden');
        comboToggle.disabled = true;
        comboToggle.classList.add('opacity-50','cursor-not-allowed');
      } else {
        comboInput.placeholder = 'Select Section';
        comboInput.readOnly = false;
        comboInput.classList.remove('cursor-not-allowed','bg-gray-50');
        comboOverlay.classList.add('hidden');
        comboToggle.disabled = false;
        comboToggle.classList.remove('opacity-50','cursor-not-allowed');
      }
    }

    setSectionComboEnabledByCourse(!!(courseSelect && courseSelect.value));

    let ALL_STUDENTS = [];
    let SECTION_STUDENTS = [];
    const SECTION_MAP = {};
    const SECTION_STU_UNSUB = {};
    let SECTIONS_UNSUB = null;

    let USER_INTERACTED = false;

    const PAGE_SIZE = 6;
    const GROUP_SIZE = 3;
    let CURRENT_PAGE = 1;
    let CURRENT_GROUP = 0;

    const initials = (s)=> (s||'').trim().split(/\s+/).slice(0,2).map(x=>x[0]?.toUpperCase()||'').join('') || 'ST';

    function renderCards(list){
      grid.innerHTML = '';
      list.forEach(s=>{
        const card = document.createElement('div');
        card.className = 'group relative bg-white rounded-2xl border border-gray-200 shadow-card hover:shadow-cardHover hover:border-primary/40 transition p-5 overflow-hidden';
        card.innerHTML = `
          <div class="pointer-events-none absolute -right-6 -top-6 w-24 h-24 rounded-full bg-primary/5 blur-2xl"></div>
          <div class="flex items-center gap-4 mb-4">
            <div class="shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-primary/10 to-emerald-50 text-primary ring-1 ring-primary/20 flex items-center justify-center font-semibold">
              ${initials(s.name)}
            </div>
            <div class="min-w-0">
              <h3 class="font-semibold text-gray-900 truncate">${s.name}</h3>
              <p class="text-xs text-gray-500">Student ID: <span class="font-medium text-gray-700">${s.id||''}</span></p>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary border border-primary/20">
              <i class="ri-layout-grid-line text-[14px]"></i>${s.section||''}
            </span>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold ${s.type==='Irregular' ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'bg-blue-100 text-blue-700 border border-blue-200'}">
              ${s.type || 'Regular'}
            </span>
            <span class="ml-auto inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold ${ (s.status||'Active')==='Active' ? 'bg-emerald-100 text-emerald-700 border border-emerald-200' : 'bg-gray-100 text-gray-700 border-gray-200'}">
              <i class="ri-checkbox-circle-line mr-1 text-[14px]"></i>${s.status || 'Active'}
            </span>
          </div>

          <div class="mt-4 h-px bg-gradient-to-r from-transparent via-gray-200 to-transparent"></div>

          <div class="mt-3 flex items-center justify-between text-xs text-gray-500">
            <div class="flex items-center gap-1"><i class="ri-book-2-line"></i><span>Section</span></div>
            <div class="font-medium text-gray-700">${s.section||''}</div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function renderPagination(totalItems){
      const totalPages = Math.ceil(totalItems / PAGE_SIZE);
      if (totalPages <= 1) {
        pagi.classList.add('hidden');
        pagi.innerHTML = '';
        return;
      }

      const maxGroup = Math.max(0, Math.ceil(totalPages / GROUP_SIZE) - 1);
      CURRENT_GROUP = Math.min(CURRENT_GROUP, maxGroup);
      const startIdx = CURRENT_GROUP * GROUP_SIZE + 1;
      const endIdx = Math.min(startIdx + GROUP_SIZE - 1, totalPages);

      const btn = (label, {active=false, disabled=false, onClick=null, title='' }={})=>{
        const el = document.createElement('button');
        el.type = 'button';
        el.className = [
          'min-w-9 h-9 px-3 inline-flex items-center justify-center rounded-button border text-sm',
          active ? 'bg-primary text-white border-primary' : 'bg-white text-gray-700 border-gray-200 hover:border-primary/40 hover:text-primary',
          disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'
        ].join(' ');
        el.innerHTML = label;
        if (title) el.title = title;
        if (!disabled && onClick) el.addEventListener('click', onClick);
        return el;
      };

      const frag = document.createDocumentFragment();

      const hasPrevGroup = CURRENT_GROUP > 0;
      frag.appendChild(
        btn('<i class="ri-arrow-right-up-line"></i>', {
          disabled: !hasPrevGroup,
          title: 'Previous pages',
          onClick: ()=>{ CURRENT_GROUP -= 1; CURRENT_PAGE = CURRENT_GROUP * GROUP_SIZE + 1; updateView(true); }
        })
      );

      for (let p = startIdx; p <= endIdx; p++){
        frag.appendChild(
          btn(String(p), {
            active: p === CURRENT_PAGE,
            onClick: ()=>{ CURRENT_PAGE = p; updateView(true); }
          })
        );
      }

      const hasNextGroup = endIdx < totalPages;
      frag.appendChild(
        btn('<i class="ri-arrow-left-down-line"></i>', {
          disabled: !hasNextGroup,
          title: 'Next pages',
          onClick: ()=>{ CURRENT_GROUP += 1; CURRENT_PAGE = CURRENT_GROUP * GROUP_SIZE + 1; updateView(true); }
        })
      );

      pagi.innerHTML = '';
      pagi.appendChild(frag);
      pagi.classList.remove('hidden');
    }

    function renderPaginated(list){
      const total = list.length;
      const totalPages = Math.ceil(total / PAGE_SIZE);

      if (CURRENT_PAGE < 1) CURRENT_PAGE = 1;
      if (CURRENT_PAGE > totalPages) CURRENT_PAGE = totalPages || 1;

      const start = (CURRENT_PAGE - 1) * PAGE_SIZE;
      const chunk = list.slice(start, start + PAGE_SIZE);
      renderCards(chunk);
      renderPagination(total);
    }

    function fillStats(results, selectedSection){
      const sectionTotal = selectedSection ? SECTION_STUDENTS.length : 0;
      const regular   = results.filter(s=> (s.type||'Regular') === 'Regular').length;
      const irregular = results.filter(s=> s.type === 'Irregular').length;
      const active    = results.filter(s=> (s.status||'Active') === 'Active').length;
      statTotal.textContent     = sectionTotal;
      statRegular.textContent   = regular;
      statIrregular.textContent = irregular;
      statActive.textContent    = active;
    }

    function rebuildAllFromMap(){
      const list = [];
      Object.keys(SECTION_MAP).forEach(secId => {
        SECTION_MAP[secId].forEach(s => list.push(s));
      });
      ALL_STUDENTS = list;
    }

    function resetPagination(){
      CURRENT_PAGE = 1;
      CURRENT_GROUP = 0;
    }

    function updateView(keepPage=false){
      const q   = searchInput.value.trim().toLowerCase();
      const sec = sectionSelect.value;

      if (!keepPage) resetPagination();

      if (q || sec) emptyState.classList.add('hidden');
      else          emptyState.classList.remove('hidden');

      if (!USER_INTERACTED) {
        grid.innerHTML = '';
        noResults.classList.add('hidden');
        noStudents.classList.add('hidden');
        statsWrap.classList.add('hidden');
        pagi.classList.add('hidden');
        return;
      }

      if (!q && !sec) {
        grid.innerHTML = '';
        noResults.classList.add('hidden');
        noStudents.classList.add('hidden');
        statsWrap.classList.add('hidden');
        pagi.classList.add('hidden');
        return;
      }

      let base = q ? ALL_STUDENTS : (sec ? SECTION_STUDENTS : ALL_STUDENTS);

      let results = base;
      if (q){
        results = base.filter(s => {
          const name    = (s.name||'').toLowerCase();
          const id      = (s.id||'').toLowerCase();
          const section = (s.section||'').toLowerCase();
          return name.includes(q) || id.includes(q) || section.includes(q);
        });
      }

      if (results.length === 0){
        grid.innerHTML = '';
        pagi.classList.add('hidden');
        if (!q && sec && SECTION_STUDENTS.length === 0){
          noStudents.classList.remove('hidden');
          noResults.classList.add('hidden');
          if (!HIDE_STATS) { statsWrap.classList.remove('hidden'); fillStats([], sec); }
          else { statsWrap.classList.add('hidden'); }
        } else {
          noResults.classList.remove('hidden');
          noStudents.classList.add('hidden');
          if (!q && sec){
            if (!HIDE_STATS) { statsWrap.classList.remove('hidden'); fillStats([], sec); }
            else { statsWrap.classList.add('hidden'); }
          } else {
            statsWrap.classList.add('hidden');
          }
        }
        return;
      }

      noResults.classList.add('hidden');
      noStudents.classList.add('hidden');

      renderPaginated(results);

      if (sec && !q && !HIDE_STATS){
        statsWrap.classList.remove('hidden');
        fillStats(results, sec);
      } else {
        statsWrap.classList.add('hidden');
      }
    }

    function subscribeAllStudents(){
      if (SECTIONS_UNSUB) {
        SECTIONS_UNSUB();
        SECTIONS_UNSUB = null;
      }
      SECTIONS_UNSUB = onSnapshot(collection(db, 'sections'), (snap)=>{
        const currentSections = new Set();
        resetCourseSectionMap();

        snap.forEach(secDoc => {
          const secId = secDoc.id;
          const data  = secDoc.data() || {};
          currentSections.add(secId);

          const course = courseFromSectionDoc(data);
          addSectionToCourse(course, secId);

          if (!SECTION_STU_UNSUB[secId]) {
            const stuRef = collection(doc(db, 'sections', secId), 'students');
            const unsub = onSnapshot(stuRef, (stuSnap)=>{
              const arr = [];
              stuSnap.forEach(sDoc=>{
                const d = sDoc.data() || {};
                const studentObj = {
                  id: d.id || d.studentId || d.studId || '',
                  name: d.name || d.fullname || d.studentName || '',
                  section: secId,
                  year: d.year || d.yearLevel || '',
                  type: d.type || 'Regular',
                  status: d.status || 'Active'
                };
                arr.push(studentObj);
              });
              SECTION_MAP[secId] = arr;
              rebuildAllFromMap();
              if (sectionSelect.value === secId){
                SECTION_STUDENTS = arr.slice();
              }
              updateView(true);
            });
            SECTION_STU_UNSUB[secId] = unsub;
          }
        });

        Object.keys(SECTION_STU_UNSUB).forEach(secId=>{
          if (!currentSections.has(secId)) {
            SECTION_STU_UNSUB[secId]();
            delete SECTION_STU_UNSUB[secId];
            delete SECTION_MAP[secId];
          }
        });

        rebuildAllFromMap();

        refreshSectionOptionsForCourse();
        updateView(true);
      });
    }

    function unsubscribeSection(){ SECTION_STUDENTS = []; }
    function subscribeSection(sectionId){
      const arr = SECTION_MAP[sectionId] || [];
      SECTION_STUDENTS = arr.slice();
      updateView();
    }

    function refreshSectionOptionsForCourse() {
      if (!courseSelect || !sectionSelect) return;
      const selectedCourse = courseSelect.value;

      if (!selectedCourse) {
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select Section';
        sectionSelect.innerHTML = '';
        sectionSelect.appendChild(placeholder);

        if (window.refreshStudentSectionCombo) window.refreshStudentSectionCombo();
        SECTION_STUDENTS = [];
        return;
      }

      const secSet = COURSE_SECTION_MAP[selectedCourse] || new Set();

      sectionSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Select Section';
      sectionSelect.appendChild(placeholder);

      Array.from(secSet).sort().forEach(secId => {
        const opt = document.createElement('option');
        opt.value = secId;
        opt.textContent = secId;
        sectionSelect.appendChild(opt);
      });

      sectionSelect.value = '';
      SECTION_STUDENTS = [];
      if (window.refreshStudentSectionCombo) window.refreshStudentSectionCombo();

      sectionSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    if (courseSelect) {
      courseSelect.addEventListener('change', ()=>{
        USER_INTERACTED = true;
        setSectionComboEnabledByCourse(!!courseSelect.value);
        refreshSectionOptionsForCourse();
      });
    }

    sectionSelect.addEventListener('change', ()=>{
      USER_INTERACTED = true;
      const sec = sectionSelect.value;
      if (sec){ subscribeSection(sec); }
      else { unsubscribeSection(); updateView(); }
    });

    searchInput.addEventListener('input', ()=>{
      USER_INTERACTED = true;
      updateView();
    });

    subscribeAllStudents();
    updateView();
  </script>

  <!-- Course Combobox UI -->
  <script>
    (function(){
      const selectEl = document.getElementById('courseSelect');
      const combo = document.getElementById('course-combo');
      const input = document.getElementById('course-input');
      const list  = document.getElementById('course-list');
      const toggleBtn = document.getElementById('course-toggle');

      let options = [];
      let realOptions = [];
      let open = false;
      let activeIndex = -1;
      let filtered = [];

      function renderList(items){
        list.innerHTML = '';
        if(items.length === 0){
          list.innerHTML = '<li class="px-3 py-2 text-gray-500">No matches</li>';
          return;
        }
        items.forEach((opt, idx) => {
          const li = document.createElement('li');
          li.role = 'option';
          li.id = 'course-opt-' + idx;
          li.tabIndex = -1;
          li.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
          li.textContent = opt.label;
          li.dataset.value = opt.value;
          li.dataset.index = String(idx);
          li.addEventListener('mousedown', (e) => {
            selectValue(opt);
            e.preventDefault();
          });
          list.appendChild(li);
        });
      }

      function computeOptionsFromSelect(){
        options = Array.from(selectEl.options).map(o => ({ value: o.value, label: o.textContent }));
        realOptions = options.filter(o => o.value !== '');
        filtered = realOptions.slice();
        renderList(filtered);
      }

      function openList(){
        if(open) return;
        list.classList.remove('hidden');
        combo.classList.add('z-30');
        input.setAttribute('aria-expanded', 'true');
        open = true;
        highlight(-1);
      }

      function closeList(){
        if(!open) return;
        list.classList.add('hidden');
        combo.classList.remove('z-30');
        input.setAttribute('aria-expanded', 'false');
        open = false;
        highlight(-1);
      }

      function highlight(index){
        activeIndex = index;
        const children = Array.from(list.children);
        children.forEach((el, i) => {
          if(i === index){
            el.classList.add('bg-gray-100');
            el.setAttribute('aria-selected', 'true');
            el.scrollIntoView({ block:'nearest' });
          } else {
            el.classList.remove('bg-gray-100');
            el.removeAttribute('aria-selected');
          }
        });
      }

      function filterList(query){
        const q = query.trim().toLowerCase();
        filtered = !q ? realOptions.slice()
                      : realOptions.filter(o =>
                          o.label.toLowerCase().includes(q) ||
                          o.value.toLowerCase().includes(q)
                        );
        renderList(filtered);
        highlight(-1);
      }

      function selectValue(opt){
        input.value = opt.label;
        selectEl.value = opt.value;
        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        closeList();
      }

      (function initFromSelect(){
        computeOptionsFromSelect();
        const selected = options.find(o => o.value === selectEl.value);
        input.value = selected && selected.value ? selected.label : '';
      })();

      input.addEventListener('focus', () => openList());
      input.addEventListener('input', () => {
        filterList(input.value);
        openList();
        if(input.value.trim() === ''){
          selectEl.value = '';
          selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      input.addEventListener('keydown', (e) => {
        const max = filtered.length - 1;
        if(e.key === 'ArrowDown'){
          e.preventDefault();
          if(!open) openList();
          highlight(Math.min(max, activeIndex + 1));
        } else if(e.key === 'ArrowUp'){
          e.preventDefault();
          if(!open) openList();
          highlight(Math.max(0, activeIndex - 1));
        } else if(e.key === 'Enter'){
          if(open && activeIndex >= 0){
            e.preventDefault();
            selectValue(filtered[activeIndex]);
          }
        } else if(e.key === 'Escape'){
          closeList();
        }
      });

      toggleBtn.addEventListener('click', () => {
        if(open){ closeList(); } else { openList(); input.focus(); }
      });

      selectEl.addEventListener('change', () => {
        computeOptionsFromSelect();
        const sel = options.find(o => o.value === selectEl.value);
        input.value = sel && sel.value ? sel.label : '';
      });

      document.addEventListener('click', (e) => {
        if(!combo.contains(e.target)) closeList();
      });
    })();
  </script>

  <!-- Section Combobox UI -->
  <script>
    (function(){
      const selectEl = document.getElementById('sectionSelect');
      const combo = document.getElementById('combo');
      const input = document.getElementById('combo-input');
      const list  = document.getElementById('combo-list');
      const toggleBtn = document.getElementById('combo-toggle');

      let options = [];
      let realOptions = [];
      let open = false;
      let activeIndex = -1;
      let filtered = [];

      function renderList(items){
        list.innerHTML = '';
        if(items.length === 0){
          list.innerHTML = '<li class="px-3 py-2 text-gray-500">No matches</li>';
          return;
        }
        items.forEach((opt, idx) => {
          const li = document.createElement('li');
          li.role = 'option';
          li.id = 'combo-opt-' + idx;
          li.tabIndex = -1;
          li.className = 'px-3 py-2 cursor-pointer hover:bg-gray-100';
          li.textContent = opt.label;
          li.dataset.value = opt.value;
          li.dataset.index = String(idx);
          li.addEventListener('mousedown', (e) => {
            selectValue(opt);
            e.preventDefault();
          });
          list.appendChild(li);
        });
      }

      function computeOptionsFromSelect(){
        // âœ… filter out any placeholder/debug option that literally shows "${sec}"
        options = Array.from(selectEl.options)
          .map(o => ({ value: o.value, label: o.textContent }))
          .filter(o => o.label.trim() !== '${sec}');
        realOptions = options.filter(o => o.value !== '');
        filtered = realOptions.slice();
        renderList(filtered);
      }

      function openList(){
        if(open) return;
        list.classList.remove('hidden');
        combo.classList.add('z-30');
        input.setAttribute('aria-expanded', 'true');
        open = true;
        highlight(-1);
      }

      function closeList(){
        if(!open) return;
        list.classList.add('hidden');
        combo.classList.remove('z-30');
        input.setAttribute('aria-expanded', 'false');
        open = false;
        highlight(-1);
      }

      function highlight(index){
        activeIndex = index;
        const children = Array.from(list.children);
        children.forEach((el, i) => {
          if(i === index){
            el.classList.add('bg-gray-100');
            el.setAttribute('aria-selected', 'true');
            el.scrollIntoView({ block:'nearest' });
          } else {
            el.classList.remove('bg-gray-100');
            el.removeAttribute('aria-selected');
          }
        });
      }

      function filterList(query){
        const q = query.trim().toLowerCase();
        filtered = !q ? realOptions.slice()
                      : realOptions.filter(o =>
                          o.label.toLowerCase().includes(q) ||
                          o.value.toLowerCase().includes(q)
                        );
        renderList(filtered);
        highlight(-1);
      }

      function selectValue(opt){
        input.value = opt.label;
        selectEl.value = opt.value;
        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        closeList();
      }

      (function initFromSelect(){
        computeOptionsFromSelect();
        const selected = options.find(o => o.value === selectEl.value);
        input.value = selected && selected.value ? selected.label : '';
      })();

      input.addEventListener('focus', () => openList());
      input.addEventListener('input', () => {
        filterList(input.value);
        openList();
        if(input.value.trim() === ''){
          selectEl.value = '';
          selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      input.addEventListener('keydown', (e) => {
        const max = filtered.length - 1;
        if(e.key === 'ArrowDown'){
          e.preventDefault();
          if(!open) openList();
          highlight(Math.min(max, activeIndex + 1));
        } else if(e.key === 'ArrowUp'){
          e.preventDefault();
          if(!open) openList();
          highlight(Math.max(0, activeIndex - 1));
        } else if(e.key === 'Enter'){
          if(open && activeIndex >= 0){
            e.preventDefault();
            selectValue(filtered[activeIndex]);
          }
        } else if(e.key === 'Escape'){
          closeList();
        }
      });

      toggleBtn.addEventListener('click', () => {
        if(open){ closeList(); } else { openList(); input.focus(); }
      });

      selectEl.addEventListener('change', () => {
        computeOptionsFromSelect();
        const sel = options.find(o => o.value === selectEl.value);
        input.value = sel && sel.value ? sel.label : '';
      });

      document.addEventListener('click', (e) => {
        if(!combo.contains(e.target)) closeList();
      });

      window.refreshStudentSectionCombo = function(){
        computeOptionsFromSelect();
        const sel = options.find(o => o.value === selectEl.value);
        input.value = sel && sel.value ? sel.label : '';
      };
    })();
  </script>

  <!-- Role gating: disable controls for students -->
  <script>
    (function(){
      const role = (sessionStorage.getItem('auth_role') || 'guest').toLowerCase();
      if (role === 'student') {
        const notice = document.getElementById('studentNotice');
        if (notice) notice.classList.remove('hidden');

        const courseInput   = document.getElementById('course-input');
        const courseToggle  = document.getElementById('course-toggle');
        const courseList    = document.getElementById('course-list');
        const courseOverlay = document.getElementById('course-overlay');
        const courseSelect  = document.getElementById('courseSelect');

        if (courseInput) {
          courseInput.value = '';
          courseInput.placeholder = 'Course selection is restricted';
          courseInput.readOnly = true;
          courseInput.classList.add('cursor-not-allowed','bg-gray-50');
          courseInput.addEventListener('focus', e => { e.target.blur(); });
          ['keydown','keypress','keyup','mousedown','mouseup','click','input'].forEach(evt =>
            courseInput.addEventListener(evt, e => e.preventDefault(), { passive:false })
          );
        }
        if (courseToggle) {
          courseToggle.disabled = true;
          courseToggle.classList.add('opacity-50','cursor-not-allowed');
          ['click','mousedown','mouseup'].forEach(evt =>
            courseToggle.addEventListener(evt, e => e.preventDefault(), { passive:false })
          );
        }
        if (courseList) courseList.classList.add('hidden');
        if (courseOverlay) courseOverlay.classList.remove('hidden');
        if (courseSelect) courseSelect.value = '';

        const comboInput = document.getElementById('combo-input');
        const comboToggle = document.getElementById('combo-toggle');
        const comboList = document.getElementById('combo-list');
        const comboOverlay = document.getElementById('combo-overlay');
        const selectEl = document.getElementById('sectionSelect');

        if (comboInput) {
          comboInput.value = '';
          comboInput.placeholder = 'Section selection is restricted';
          comboInput.readOnly = true;
          comboInput.classList.add('cursor-not-allowed','bg-gray-50');
          comboInput.addEventListener('focus', e => { e.target.blur(); });
          ['keydown','keypress','keyup','mousedown','mouseup','click','input'].forEach(evt =>
            comboInput.addEventListener(evt, e => e.preventDefault(), { passive:false })
          );
        }
        if (comboToggle) {
          comboToggle.disabled = true;
          comboToggle.classList.add('opacity-50','cursor-not-allowed');
          ['click','mousedown','mouseup'].forEach(evt =>
            comboToggle.addEventListener(evt, e => e.preventDefault(), { passive:false })
          );
        }
        if (comboList) comboList.classList.add('hidden');
        if (comboOverlay) comboOverlay.classList.remove('hidden');
        if (selectEl) selectEl.value = '';

        const searchInput = document.getElementById('searchInput');
        const searchOverlay = document.getElementById('search-overlay');
        if (searchInput) {
          searchInput.value = '';
          searchInput.placeholder = 'Search is restricted to teachers/admin';
          searchInput.readOnly = true;
          searchInput.classList.add('cursor-not-allowed','bg-gray-50');
          searchInput.addEventListener('focus', e => { e.target.blur(); });
          ['keydown','keypress','keyup','mousedown','mouseup','click','input','paste'].forEach(evt =>
            searchInput.addEventListener(evt, e => e.preventDefault(), { passive:false })
          );
        }
        if (searchOverlay) searchOverlay.classList.remove('hidden');
      }
    })();
  </script>

  <script src="assets/js/profile.js"></script>
  <script src="assets/js/nav.js"></script>
</body>
</html>
