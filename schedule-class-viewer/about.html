<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sign In â€¢ SLSU Lucena BIT</title>
  <script src="https://cdn.tailwindcss.com/3.4.16"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          /* Dark green like homepage */
          colors: { primary:'#0A4B2D', secondary:'#0A4B2D' },
          borderRadius: { 'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px' },
          boxShadow: { glow: '0 10px 30px rgba(10,75,45,.15)' },
          keyframes:{
            fadeIn:{ from:{opacity:0,transform:'translateY(6px)'}, to:{opacity:1,transform:'none'} },
            fadeOut:{ from:{opacity:1}, to:{opacity:0} },
            pulseCard:{ '0%,100%':{ boxShadow:'0 10px 30px rgba(10,75,45,.15)' }, '50%':{ boxShadow:'0 16px 50px rgba(10,75,45,.35)'} }
          },
          animation:{
            'fade-in':'fadeIn .25s ease-out both',
            'fade-out':'fadeOut .25s ease-in both',
            'pulse-card':'pulseCard 1.6s ease-in-out 1'
          }
        }
      }
    }
  </script>
  <link rel="icon" href="lucenalogo.jpg" type="image/png" sizes="48Ã—48">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
  <style>
    :where([class^="ri-"])::before{content:"\f3c2";}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    @media (min-width: 768px){ .bg-shift-top{ background-position: center -140px !important; } }
    @media (max-width: 767px){ .bg-shift-top{ background-position: center -80px !important; } }
    /* Make sure the Register CTA is never sticky / fixed */
    #register-cta { position: static !important; }

    /* Suggestion panel styles */
    .reg-suggest-panel{
      position:absolute; left:2.5rem; right:.75rem; z-index:50; margin-top:.25rem;
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
      max-height:14rem; overflow:auto;
    }
    .reg-suggest-item{ padding:.6rem .8rem; border-radius:10px; cursor:pointer; }
    .reg-suggest-item:hover{ background:#f8fafc; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 top-5 z-[60] hidden">
    <div class="rounded-xl bg-white shadow-2xl border border-green-200 px-4 py-3 text-sm text-green-800 flex items-center gap-2">
      <i class="ri-check-double-line text-lg"></i>
      <span id="toast-msg"></span>
    </div>
  </div>

  <main class="pt-0">
    <section class="min-h-[calc(100vh-5rem)] bg-white relative overflow-hidden">
      <div class="absolute inset-0">
        <div class="absolute inset-0 bg-center bg-cover opacity-30 bg-shift-top" style="background-image:url('lucena.png')"></div>
        <div class="absolute inset-0 bg-gradient-to-br from-white/30 via-white/20 to-white/10"></div>
        <div class="absolute -left-24 top-24 w-72 h-72 rounded-full bg-primary/10 blur-3xl"></div>
        <div class="absolute -right-24 bottom-10 w-72 h-72 rounded-full bg-secondary/10 blur-3xl"></div>
      </div>

      <div class="relative px-6 py-12">
        <div class="max-w-[560px] mx-auto mb-4 px-4 flex items-center gap-3">
          <img src="lucenalogo.jpg" alt="SLSU Lucena Logo" class="w-9 h-9 rounded-full object-cover ring-2 ring-primary/20">
          <div class="leading-tight">
            <div class="text-sm font-semibold text-gray-800">SLSU Lucena</div>
            <div class="text-[11px] text-gray-500 -mt-0.5">Class Schedule Management System</div>
          </div>
          <div class="ml-auto flex items-center gap-2 text-gray-500 text-xs">
            <i class="ri-time-line"></i><span>Academic Year 2025â€“2026</span>
          </div>
        </div>

        <div id="login-card" class="max-w-[560px] mx-auto bg-white rounded-2xl border border-gray-200 shadow-glow overflow-hidden animate-fade-in">
          <div class="bg-primary text-white px-6 py-5">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-full bg-white/20 flex items-center justify-center">
                <i class="ri-key-2-line text-xl"></i>
              </div>
              <div>
                <h2 class="text-lg font-bold leading-none">Sign In</h2>
                <p class="text-[12px] opacity-90">Access your class schedule and manage your academic information</p>
              </div>
            </div>
          </div>

        <div class="px-5 md:px-6 pt-5 md:pt-6">
          <div class="inline-flex bg-gray-100 p-1 rounded-full text-sm">
            <button id="tab-student" class="tab-btn px-4 py-2 rounded-full font-medium bg-white text-primary shadow-sm flex items-center gap-2 transition">
              <i class="ri-graduation-cap-line"></i><span>Student</span>
            </button>
            <button id="tab-teacher" class="tab-btn px-4 py-2 rounded-full text-gray-700 hover:text-primary flex items-center gap-2 transition">
              <i class="ri-user-voice-line"></i><span>Teacher</span>
            </button>
            <button id="tab-admin" class="tab-btn px-4 py-2 rounded-full text-gray-700 hover:text-primary flex items-center gap-2 transition">
              <i class="ri-shield-user-line"></i><span>Admin</span>
            </button>
          </div>
        </div>

          <!-- Only the FORM area scrolls; CTA below does not stick while scrolling -->
          <div class="px-5 md:px-6 py-5 md:py-6 max-h-[60vh] overflow-y-auto">
            <form id="login-form" class="space-y-4" autocomplete="off">
              <div id="student-name-row" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <div class="relative">
                  <i class="ri-user-3-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                  <input id="student-fullname" type="text" autocomplete="off" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your full name">
                </div>
              </div>

              <div>
                <label id="id-label" class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
                <div class="relative">
                  <i class="ri-id-card-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                  <input id="id-input" type="text" autocomplete="off" required class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your student ID">
                </div>
              </div>

              <div id="email-row" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <div class="relative">
                  <i class="ri-mail-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                  <input id="email-input" type="email" autocomplete="email" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your email address">
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <div class="relative">
                  <i class="ri-lock-2-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                  <input id="password-input" type="password" autocomplete="new-password" name="new-password" required class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your password" value="">
                  <button type="button" id="toggle-pass" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="ri-eye-line"></i>
                  </button>
                </div>
              </div>

              <div id="student-section-row" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Section</label>
                <div class="relative">
                  <i class="ri-layout-grid-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>

                  <!-- kept original select but hidden & synced -->
                  <select id="student-section" class="hidden w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                    <option value="" disabled selected>Select your section</option>
                    <option>BIT 1A-A</option>
                    <option>BIT 1A-B</option>
                    <option>BIT 1B-A</option>
                    <option>BIT 1B-B</option>
                    <option>BIT 2A-A</option>
                    <option>BIT 2A-B</option>
                    <option>BIT 2B-A</option>
                    <option>BIT 2B-B</option>
                    <option>BIT 3A-A</option>
                    <option>BIT 3A-B</option>
                    <option>BIT 3B-A</option>
                    <option>BIT 3B-B</option>
                    <option>BIT 4A-A</option>
                    <option>BIT 4A-B</option>
                    <option>BIT 4B-A</option>
                    <option>BIT 4B-B</option>
                  </select>

                  <!-- (Sign-in view keeps this row hidden anyway, unchanged) -->
                </div>
              </div>

              <div class="flex items-center justify-end pt-1">
                <a href="#" class="text-sm text-primary hover:underline">Forgot password?</a>
              </div>

              <button id="submit-btn" type="submit" class="w-full px-4 py-3 bg-primary text-white rounded-button hover:bg-primary/90 transition shadow-sm active:scale-[.99]">
                Sign in as Student
              </button>
            </form>
          </div>

          <div class="px-5 md:px-6 pb-5 md:pb-6">
            <!-- Non-sticky CTA; outside the scrollable form area -->
            <div id="register-cta" class="rounded-xl border border-primary/20 bg-primary/5 p-4 text-sm">
              <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="text-gray-700">
                  <div class="font-semibold">New to SLSU Lucena?</div>
                  <div class="text-gray-600">Create your account to access the class schedule management system.</div>
                </div>
                <button id="open-register" class="px-4 py-2 rounded-button border border-primary text-primary hover:bg-primary/10 transition">
                  Register Now
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Smaller footer (only size adjusted) -->
  <footer class="bg-primary text-white py-8">
    <div class="px-6">
      <div class="max-w-6xl mx-auto">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-lg font-bold mb-3">SLSU Lucena Campus</h3>
            <p class="text-white/80 mb-3">Southern Luzon State University Lucena Campus</p>
            <div class="flex items-center space-x-3">
              <a href="https://www.facebook.com/profile.php?id=100064260360036" target="_blank" rel="noopener noreferrer" aria-label="SLSU Lucena Facebook Page" class="p-2 rounded-full hover:bg-white/10 transition active:scale-95">
                <i class="ri-facebook-line text-xl"></i>
              </a>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-bold mb-3">Contact Information</h3>
            <div class="space-y-2 text-white/80">
              <div class="flex items-center space-x-3"><i class="ri-map-pin-line"></i><span>Ibabang Dupay, Lucena City</span></div>
              <div class="flex items-center space-x-3"><i class="ri-phone-line"></i><span>(042) 123-4567</span></div>
              <div class="flex items-center space-x-3"><i class="ri-mail-line"></i><span>info@slsu-lucena.edu.ph</span></div>
            </div>
          </div>
        </div>
        <div class="border-t border-white/20 mt-4 pt-4 text-center text-white/80 text-sm">
          <p>&copy; 2025 SLSU Lucena Class Schedule Viewer. All rights reserved.</p>
        </div>
      </div>
    </div>
  </footer>

  <script type="module" src="assets/js/firebase-config.js"></script>
  <script>
    if (location.hostname === '127.0.0.1') { location.replace(location.href.replace('127.0.0.1', 'localhost')); }
  </script>

  <!-- Register Modal -->
  <div id="register-modal" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div id="register-panel" class="relative z-[71] w-full max-w-xl mx-auto mt-20 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
      <div class="bg-primary text-white px-6 py-4 flex items-center justify-between">
        <div>
          <h3 id="register-title" class="text-lg font-bold">Create an Account</h3>
          <p id="register-subtitle" class="text-xs opacity-90">Choose your role to continue</p>
        </div>
        <button id="close-register" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>

      <!-- Role chooser -->
      <div id="register-role" class="p-6">
        <div class="grid md:grid-cols-2 gap-4">
          <button id="choose-student" class="p-5 border border-gray-200 rounded-xl hover:shadow-md active:scale-[.99] transition text-left">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center">
                <i class="ri-graduation-cap-line text-xl"></i>
              </div>
              <div>
                <div class="font-semibold">Student</div>
                <div class="text-xs text-gray-600">Register with Student ID & Section</div>
              </div>
            </div>
          </button>
          <button id="choose-teacher" class="p-5 border border-gray-200 rounded-xl hover:shadow-md active:scale-[.99] transition text-left">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center">
                <i class="ri-user-voice-line text-xl"></i>
              </div>
              <div>
                <div class="font-semibold">Teacher</div>
                <div class="text-xs text-gray-600">Register with your email</div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <!-- Registration form (hidden until role chosen) -->
      <div id="register-form-wrap" class="p-6 hidden">
        <form id="register-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
            <div class="relative">
              <i class="ri-user-3-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input id="reg-fullname" type="text" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your full name">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
            <div class="relative">
              <i class="ri-mail-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input id="reg-email" type="email" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Enter your email">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <div class="relative">
              <i class="ri-lock-2-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input id="reg-password" type="password" class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="Create a password">
              <button type="button" id="toggle-reg-pass" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <i class="ri-eye-line"></i>
              </button>
            </div>
          </div>

          <!-- Student-only fields -->
          <div id="reg-student-id-group" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
            <div class="relative">
              <i class="ri-id-card-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <input id="reg-student-id" type="text" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm" placeholder="e.g. 2025-000001">
            </div>
          </div>

          <div id="reg-student-section-group" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Section</label>
            <div class="relative">
              <i class="ri-layout-grid-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>

              <!-- kept original select, now hidden & synced -->
              <select id="reg-section" class="hidden w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                <option value="" disabled selected>Select your section</option>
                <option>BIT 1A-A</option>
                <option>BIT 1A-B</option>
                <option>BIT 1B-A</option>
                <option>BIT 1B-B</option>
                <option>BIT 2A-A</option>
                <option>BIT 2A-B</option>
                <option>BIT 2B-A</option>
                <option>BIT 2B-B</option>
                <option>BIT 3A-A</option>
                <option>BIT 3A-B</option>
                <option>BIT 3B-A</option>
                <option>BIT 3B-B</option>
                <option>BIT 4A-A</option>
                <option>BIT 4A-B</option>
                <option>BIT 4B-A</option>
                <option>BIT 4B-B</option>
              </select>

              <!-- Searchable input + suggestions (no default list; only when typing) -->
              <input id="reg-section-combo" type="text" autocomplete="off"
                     class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm"
                     placeholder="Type your section (e.g., BIT 3A-A)">
              <div id="reg-section-suggest" class="reg-suggest-panel hidden"></div>
              <input type="hidden" id="reg-section-input" />
            </div>
          </div>

          <div id="reg-student-status-group" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <div class="relative">
              <i class="ri-information-line absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
              <!-- Only Regular / Irregular -->
              <select id="reg-status" class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-button focus:ring-2 focus:ring-primary focus:border-primary text-sm">
                <option value="" selected>â€” Select status â€”</option>
                <option>Regular</option>
                <option>Irregular</option>
              </select>
            </div>
          </div>

          <div class="pt-2">
            <button id="register-submit" type="submit" class="w-full px-4 py-3 bg-primary text-white rounded-button hover:bg-primary/90 transition active:scale-[.99]">
              Create account
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- END Register Modal -->

  <script type="module">
    import {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      updateProfile,
      fetchSignInMethodsForEmail,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      doc, getDoc, setDoc, serverTimestamp,
      onSnapshot, collection
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const { auth, db } = window.__FB;

    const toast = (msg) => {
      const box = document.getElementById('toast');
      const span = document.getElementById('toast-msg');
      span.textContent = msg;
      box.classList.remove('hidden');
      box.classList.remove('animate-fade-out');
      box.classList.add('animate-fade-in');
      setTimeout(() => {
        box.classList.remove('animate-fade-in');
        box.classList.add('animate-fade-out');
        setTimeout(()=> box.classList.add('hidden'), 250);
      }, 1600);
    };
    const capWords = (s)=> s.split(/[\s._-]+/).filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(' ');
    const setSession = (obj)=> Object.entries(obj).forEach(([k,v])=> v==null ? sessionStorage.removeItem(k) : sessionStorage.setItem(k,String(v)));

    // never downgrade/flip an existing role
    const ensureUserDoc = async (uid, data) => {
      const ref = doc(db, 'users', uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const current = snap.data();
        const next = { ...current, ...data };
        if (current.role && data.role && current.role !== data.role) {
          next.role = current.role; // keep original role
        }
        await setDoc(ref, { ...next, updatedAt: serverTimestamp() });
      } else {
        await setDoc(ref, { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
      }
    };

    const tabStudent = document.getElementById('tab-student');
    const tabTeacher = document.getElementById('tab-teacher');
    const tabAdmin   = document.getElementById('tab-admin');

    const idLabel = document.getElementById('id-label');
    const idInput = document.getElementById('id-input');
    const submitBtn = document.getElementById('submit-btn');

    const studentRow = document.getElementById('student-section-row');
    const studentNameRow = document.getElementById('student-name-row');
    const emailRow = document.getElementById('email-row');
    const emailInput = document.getElementById('email-input');
    const passInput = document.getElementById('password-input');
    const registerCta = document.getElementById('register-cta');
    let currentRole = 'student';

    const idGroup = idLabel.parentElement;

    // loading state
    const setLoading = (btn, on, customLabel) => {
      if (on) {
        if (!btn.dataset.orig) btn.dataset.orig = btn.innerHTML;
        const label = customLabel || (btn.textContent || 'Loading');
        btn.disabled = true;
        btn.setAttribute('aria-busy','true');
        btn.innerHTML = `
          <span class="inline-flex items-center justify-center gap-2">
            <svg class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" d="M22 12a10 10 0 00-10-10" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path>
            </svg>
            <span>${label}</span>
          </span>`;
      } else {
        if (btn.dataset.orig) {
          btn.innerHTML = btn.dataset.orig;
          delete btn.dataset.orig;
        }
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
      }
    };

    const setActive = (tab)=>{
      [tabStudent, tabTeacher, tabAdmin].forEach(b=>{
        b.classList.remove('bg-white','text-primary','shadow-sm');
        b.classList.add('text-gray-700');
      });
      tab.classList.add('bg-white','text-primary','shadow-sm');
      tab.classList.remove('text-gray-700');
    };

    const errCls = ['border-red-500','ring-2','ring-red-400','focus:ring-red-500','focus:border-red-500'];
    const clearErr = (el)=>{ el?.classList?.remove(...errCls); el?.removeAttribute?.('aria-invalid'); };
    const setErr   = (el)=>{ el?.classList?.add(...errCls); el?.setAttribute?.('aria-invalid','true'); };
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const getActiveEmailInput = ()=> currentRole==='student' ? emailInput : idInput;

    [emailInput, idInput, passInput].forEach(el=>{
      el.addEventListener('input', ()=> clearErr(el));
      el.addEventListener('focus',  ()=> clearErr(el));
    });

    tabStudent.addEventListener('click', () => {
      setActive(tabStudent);
      currentRole = 'student';
      idGroup.classList.add('hidden');
      idInput.required = false;
      idInput.disabled = true;
      emailRow.classList.remove('hidden');
      emailInput.required = true;
      studentRow.classList.add('hidden');
      studentNameRow.classList.add('hidden');
      submitBtn.textContent = 'Sign in as Student';
      registerCta?.classList.remove('hidden'); // show CTA for non-admin
      clearErr(idInput); clearErr(emailInput); clearErr(passInput);
      passInput.value = ''; passInput.setAttribute('value','');
    });
    tabTeacher.addEventListener('click', () => {
      setActive(tabTeacher);
      currentRole = 'teacher';
      idLabel.textContent = 'Email Address';
      idInput.placeholder = 'Enter your email address';
      idInput.type = 'email';
      idGroup.classList.remove('hidden');
      idInput.required = true;
      idInput.disabled = false;
      emailRow.classList.add('hidden');
      emailInput.required = false;
      studentRow.classList.add('hidden');
      studentNameRow.classList.add('hidden');
      submitBtn.textContent = 'Sign in as Teacher';
      registerCta?.classList.remove('hidden');
      clearErr(idInput); clearErr(emailInput); clearErr(passInput);
      passInput.value = ''; passInput.setAttribute('value','');
    });
    tabAdmin.addEventListener('click', () => {
      setActive(tabAdmin);
      currentRole = 'admin';
      idLabel.textContent = 'Username (email)';
      idInput.placeholder = 'Enter your admin email';
      idInput.type = 'email';
      idGroup.classList.remove('hidden');
      idInput.required = true;
      idInput.disabled = false;
      emailRow.classList.add('hidden');
      emailInput.required = false;
      studentRow.classList.add('hidden');
      studentNameRow.classList.add('hidden');
      submitBtn.textContent = 'Sign in as Admin';
      registerCta?.classList.add('hidden'); // HIDE CTA on Admin tab
      clearErr(idInput); clearErr(emailInput); clearErr(passInput);
      passInput.value = ''; passInput.setAttribute('value','');
    });

    tabStudent.click();

    function applyRoleFromQuery() {
      const q = new URLSearchParams(location.search);
      const role = q.get('role');
      const email = q.get('email');
      if (role === 'teacher') {
        tabTeacher.click();
        if (email) idInput.value = email;
      } else if (role === 'admin') {
        tabAdmin.click();
        if (email) idInput.value = email;
      } else if (role === 'student') {
        tabStudent.click();
        if (email) emailInput.value = email;
      }
      if (role) history.replaceState({}, '', location.pathname);
    }
    applyRoleFromQuery();

    document.getElementById('toggle-pass').addEventListener('click', ()=>{
      const isPwd = passInput.type === 'password';
      passInput.type = isPwd ? 'text' : 'password';
      document.getElementById('toggle-pass').innerHTML = isPwd ? '<i class="ri-eye-off-line"></i>' : '<i class="ri-eye-line"></i>';
    });

    document.getElementById('login-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!navigator.onLine) { toast('You are offline.'); return; }

      const password = passInput.value.trim();
      const idValue  = idInput.value.trim();
      const emailVal = (currentRole==='student' ? emailInput.value.trim() : idValue);

      clearErr(getActiveEmailInput()); clearErr(passInput);
      if (!emailVal || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal)) { setErr(getActiveEmailInput()); toast('Enter a valid email.'); return; }
      if (!password) { setErr(passInput); toast('Enter your password.'); return; }

      const roleLabel = currentRole==='teacher' ? 'Teacher' : currentRole==='admin' ? 'Admin' : 'Student';
      setLoading(submitBtn, true, `Signing in as ${roleLabel}â€¦`);

      try {
        const { user } = await signInWithEmailAndPassword(auth, emailVal, password);
        const snap = await getDoc(doc(db, 'users', user.uid));
        const data = snap.exists() ? snap.data() : {};

        const storedRole = (data.role || '').toLowerCase();
        if (!storedRole) {
          await signOut(auth);
          setLoading(submitBtn, false);
          toast('This account has no role assigned. Please contact support.');
          return;
        }
        if (storedRole !== currentRole) {
          await signOut(auth);
          setLoading(submitBtn, false);
          toast(`This account is registered as ${storedRole.charAt(0).toUpperCase()+storedRole.slice(1)}. Please use the ${storedRole} tab.`);
          return;
        }

        const name = data.name || user.displayName || emailVal.split('@')[0];
        if (storedRole === 'student') {
          const section   = data.section   || '';
          const studentId = data.studentId || '';
          const status    = data.status    || '';
          setSession({
            auth_name: name,
            auth_role: 'student',
            auth_email: emailVal,
            auth_id: studentId,
            auth_section: section,
            auth_status: status
          });
          await ensureUserDoc(user.uid, { name, email: emailVal, role: 'student', studentId: studentId || null, section: section || null, status: status || null });
        } else if (storedRole === 'teacher' || storedRole === 'admin') {
          const displayName = name || capWords(emailVal.split('@')[0].replace(/\d+/g,'') || storedRole);
          await ensureUserDoc(user.uid, { name: displayName, email: emailVal, role: storedRole });
          await updateProfile(user, { displayName });
          setSession({
            auth_name: displayName,
            auth_role: storedRole,
            auth_email: emailVal,
            auth_id: emailVal.split('@')[0],
            auth_section: null,
            auth_status: null
          });
        }

        window.location.href = 'index.html?welcome=1';
      } catch (err) {
        await handleAuthErrorAccurate(err, emailVal);
      } finally {
        setLoading(submitBtn, false);
      }
    });

    async function handleAuthErrorAccurate(err, emailVal){
      const code = err?.code || '';
      const emailEl = getActiveEmailInput();

      if (code === 'auth/user-not-found') {
        setErr(emailEl); toast('Account not found. Please register first.'); return;
      }
      if (code === 'auth/invalid-email') {
        setErr(emailEl); toast('Enter a valid email address.'); return;
      }
      if (code === 'auth/too-many-requests') {
        setErr(passInput); toast('Too many attempts. Try again later.'); return;
      }

      if (code === 'auth/invalid-credential' || code === 'auth/wrong-password') {
        try {
          const methods = await fetchSignInMethodsForEmail(auth, emailVal);
          if (Array.isArray(methods) && methods.length > 0) {
            setErr(passInput); toast('Incorrect password.');
          } else {
            setErr(emailEl); toast('Account not found. Please register first.');
          }
        } catch {
          setErr(passInput); toast('Email or password is incorrect.');
        }
        return;
      }

      setErr(passInput);
      toast(err.message?.replace('Firebase: ','') || 'Sign-in failed.');
    }

    // Register modal
    const regModal = document.getElementById('register-modal');
    const registerPanel = document.getElementById('register-panel');
    const openRegister = document.getElementById('open-register');
    const closeRegister = document.getElementById('close-register');
    const roleView = document.getElementById('register-role');
    const formWrap = document.getElementById('register-form-wrap');
    const regTitle = document.getElementById('register-title');
    const regSubtitle = document.getElementById('register-subtitle');
    const chooseStudent = document.getElementById('choose-student');
    const chooseTeacher = document.getElementById('choose-teacher');
    const regStudentIdGroup = document.getElementById('reg-student-id-group');
    const regStudentSectionGroup = document.getElementById('reg-student-section-group');
    const regStudentStatusGroup = document.getElementById('reg-student-status-group');
    const toggleRegPass = document.getElementById('toggle-reg-pass');
    const regPassword = document.getElementById('reg-password');
    const regSubmit = document.getElementById('register-submit');

    // elements for searchable section
    const regSectionSelect  = document.getElementById('reg-section');          // kept (hidden)
    const regSectionInput   = document.getElementById('reg-section-input');    // hidden value
    const regSectionCombo   = document.getElementById('reg-section-combo');    // text input
    const regSectionSuggest = document.getElementById('reg-section-suggest');  // panel
    let REG_SECTION_SOURCE = [];

    function seedSectionsFromSelect(){
      const arr = [];
      Array.from(regSectionSelect?.options || []).forEach(op=>{
        const v = (op.value || op.textContent || '').trim();
        if (v && v.toLowerCase() !== 'select your section') arr.push(v);
      });
      return arr;
    }
    const idxText = (s)=> (s||'').toLowerCase().replace(/\s+/g,' ').trim();
    function dedupeSorted(list){
      const set = new Set(); const out=[];
      list.forEach(s=>{ const k=s.trim(); if(k && !set.has(k)) { set.add(k); out.push(k); } });
      return out.sort((a,b)=> a.localeCompare(b));
    }
    // Render suggestions (show ALL matches; do not show when empty query)
    function renderRegSectionSuggestions(list){
      if (!list.length){ regSectionSuggest.classList.add('hidden'); regSectionSuggest.innerHTML=''; return; }
      regSectionSuggest.innerHTML = list.map(s=>`
        <div class="reg-suggest-item" data-value="${s.replace(/"/g,'&quot;')}">${s}</div>
      `).join('');
      regSectionSuggest.classList.remove('hidden');
    }
    // Filter with priority: starts-with then contains; hide on empty
    function filterRegSections(qRaw){
      const q = idxText(qRaw);
      if (!q){ regSectionSuggest.classList.add('hidden'); regSectionSuggest.innerHTML=''; return; }
      const starts = REG_SECTION_SOURCE.filter(s=> idxText(s).startsWith(q));
      const contains = REG_SECTION_SOURCE.filter(s=> !idxText(s).startsWith(q) && idxText(s).includes(q));
      renderRegSectionSuggestions([...starts, ...contains]);
    }
    function applyRegSection(val){
      regSectionInput.value = val;
      regSectionCombo.value = val;
      const opt = Array.from(regSectionSelect.options).find(o => (o.value||o.textContent).trim().toLowerCase() === val.trim().toLowerCase());
      if (opt){ regSectionSelect.value = opt.value || opt.textContent.trim(); }
      regSectionSuggest.classList.add('hidden');
    }

    regSectionCombo?.addEventListener('input', ()=> filterRegSections(regSectionCombo.value));
    regSectionCombo?.addEventListener('focus', ()=> filterRegSections(regSectionCombo.value));
    regSectionCombo?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        const first = regSectionSuggest.querySelector('.reg-suggest-item');
        if (first){ applyRegSection(first.dataset.value || first.textContent.trim()); }
      } else if (e.key === 'Escape'){
        regSectionSuggest.classList.add('hidden');
      }
    });
    document.addEventListener('mousedown', (e)=>{
      if (!regSectionSuggest.contains(e.target) && e.target !== regSectionCombo){
        regSectionSuggest.classList.add('hidden');
      }
    });
    regSectionSuggest?.addEventListener('mousedown', (e)=>{
      const it = e.target.closest('.reg-suggest-item'); if (!it) return;
      applyRegSection(it.dataset.value || it.textContent.trim());
    });

    // Live Firestore sections
    function observeSectionsForRegister(){
      REG_SECTION_SOURCE = seedSectionsFromSelect();
      onSnapshot(collection(db,'sections'), (snap)=>{
        const fromFS = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          const name = (data.name || d.id || '').trim();
          if (name) fromFS.push(name);
        });
        REG_SECTION_SOURCE = dedupeSorted([...REG_SECTION_SOURCE, ...fromFS]);
        if (document.activeElement === regSectionCombo){
          filterRegSections(regSectionCombo.value);
        }
      });
    }
    observeSectionsForRegister();

    let registerRole = null; // 'student' | 'teacher'

    openRegister.addEventListener('click', () => {
      regTitle.textContent = 'Create an Account';
      regSubtitle.textContent = 'Choose your role to continue';
      roleView.classList.remove('hidden');
      formWrap.classList.add('hidden');
      regModal.classList.remove('hidden');
      regPassword.value = ''; regPassword.setAttribute('value','');
      registerRole = null;
      // reset section inputs
      regSectionInput.value = '';
      regSectionCombo.value = '';
      regSectionSuggest.classList.add('hidden');
    });
    const closeReg = ()=> regModal.classList.add('hidden');
    closeRegister.addEventListener('click', closeReg);
    regModal.addEventListener('click', (e)=>{ if(e.target === regModal) closeReg(); });

    chooseStudent.addEventListener('click', ()=>{
      registerRole = 'student';
      regTitle.textContent = 'Register as Student';
      regSubtitle.textContent = 'Fill out the information below';
      roleView.classList.add('hidden');
      formWrap.classList.remove('hidden');
      regStudentIdGroup.classList.remove('hidden');
      regStudentSectionGroup.classList.remove('hidden');
      regStudentStatusGroup.classList.remove('hidden');
      regPassword.value = ''; regPassword.setAttribute('value','');
      setTimeout(()=> regSectionCombo?.focus(), 50);
    });
    chooseTeacher.addEventListener('click', ()=>{
      registerRole = 'teacher';
      regTitle.textContent = 'Register as Teacher';
      regSubtitle.textContent = 'Fill out the information below';
      roleView.classList.add('hidden');
      formWrap.classList.remove('hidden');
      regStudentIdGroup.classList.add('hidden');
      regStudentSectionGroup.classList.add('hidden');
      regStudentStatusGroup.classList.add('hidden');
      regPassword.value = ''; regPassword.setAttribute('value','');
    });

    toggleRegPass.addEventListener('click', ()=>{
      const isPwd = regPassword.type === 'password';
      regPassword.type = isPwd ? 'text' : 'password';
      toggleRegPass.innerHTML = isPwd ? '<i class="ri-eye-off-line"></i>' : '<i class="ri-eye-line"></i>';
    });

    document.getElementById('register-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!navigator.onLine) { toast('You are offline.'); return; }

      const full = document.getElementById('reg-fullname').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const pass  = document.getElementById('reg-password').value.trim();
      const sidEl = document.getElementById('reg-student-id');
      const secEl = document.getElementById('reg-section');
      const statEl = document.getElementById('reg-status');

      const secInputEl = document.getElementById('reg-section-input');
      const sid   = sidEl && sidEl.value ? sidEl.value.trim() : '';
      const sec   = (secInputEl && secInputEl.value ? secInputEl.value.trim() : (secEl && secEl.value ? secEl.value.trim() : ''));
      const stat  = statEl && statEl.value ? statEl.value.trim() : '';

      if (!registerRole) { toast('Please choose Student or Teacher.'); return; }
      if (registerRole === 'student') {
        if (!sid || !sec) { toast('Student ID and Section are required.'); return; }
        if (!/^(Regular|Irregular)$/i.test(stat || '')) { toast('Please select status: Regular or Irregular.'); return; }
      }

      setLoading(regSubmit, true, 'Creating accountâ€¦');

      try {
        const { user } = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(user, { displayName: full || capWords(email.split('@')[0]) });
        await ensureUserDoc(user.uid, {
          name: full || capWords(email.split('@')[0]),
          email,
          role: registerRole,
          studentId: registerRole==='student' ? sid : null,
          section:   registerRole==='student' ? sec : null,
          status:    registerRole==='student' ? (stat || null) : null
        });

        toast("You're now registered ðŸŽ‰");
        const qp = new URLSearchParams({ role: registerRole, email }).toString();
        registerPanel.classList.add('animate-fade-out');
        setTimeout(()=>{
          regModal.classList.add('hidden');
          registerPanel.classList.remove('animate-fade-out');
          location.href = location.pathname + '?' + qp;
        }, 250);

      } catch (err) {
        toast(err.message?.replace('Firebase: ', '') || 'Registration failed.');
      } finally {
        setLoading(regSubmit, false);
      }
    });
  </script>
</body>
</html>
